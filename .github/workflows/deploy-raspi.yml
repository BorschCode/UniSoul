name: Deploy to Raspberry Pi

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Docker image tag to deploy"
        required: true
        default: "latest"

jobs:
  deploy:
    name: Deploy UniSoul to Raspberry Pi
    runs-on: [self-hosted, Linux, ARM]
    environment: raspberry

    steps:
      # ------------------------
      # Extract image tag
      # ------------------------
      - name: Extract image tag
        id: image_tag
        run: |
          TAG="${{ github.event.inputs.image_tag }}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Deploying image tag: ${TAG}"

      # ------------------------
      # Detect architecture
      # ------------------------
      - name: Detect platform architecture
        id: arch
        run: |
          ARCH=$(uname -m)
          echo "Detected architecture: $ARCH"

          if [ "$ARCH" = "aarch64" ]; then
            PLATFORM="linux/arm64"
          elif [ "$ARCH" = "armv7l" ] || [ "$ARCH" = "armv6l" ]; then
            PLATFORM="linux/arm/v7"
          elif [ "$ARCH" = "x86_64" ]; then
            PLATFORM="linux/amd64"
          else
            echo "Unsupported architecture: $ARCH"
            exit 1
          fi

          echo "platform=${PLATFORM}" >> $GITHUB_OUTPUT
          echo "Using Docker platform: ${PLATFORM}"

      # ------------------------
      # Cleanup workspace safely
      # ------------------------
      - name: Clean workspace
        run: |
          find "${{ github.workspace }}" -mindepth 1 -maxdepth 1 ! -name ".git" -exec rm -rf {} +

      # ------------------------
      # Checkout code
      # ------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # ------------------------
      # Docker login
      # ------------------------
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # ------------------------
      # Free memory before pulling
      # ------------------------
      - name: Free up memory before pull
        run: |
          echo "Freeing up memory..."
          docker system prune -af --volumes || true
          sync
          free -h
          df -h

      # ------------------------
      # Pull image
      # ------------------------
      - name: Pull image with platform specification
        run: |
          PLATFORM="${{ steps.arch.outputs.platform }}"
          IMAGE="${{ secrets.DOCKER_USERNAME }}/unisoul:${{ steps.image_tag.outputs.tag }}"

          echo "Pulling image: ${IMAGE}"
          echo "Platform: ${PLATFORM}"

          for i in {1..3}; do
            echo "Pull attempt $i of 3..."
            if docker pull --platform ${PLATFORM} ${IMAGE}; then
              echo "Image pulled successfully!"
              exit 0
            fi
            echo "Pull failed, retrying..."
            docker system prune -af || true
            sleep 10
          done

          echo "Failed to pull image after 3 attempts"
          exit 1

      # ------------------------
      # Stop old containers
      # ------------------------
      - name: Stop and remove old container
        run: |
          docker compose -f compose.override.raspberry.yml down --remove-orphans || true
          docker ps -aq --filter "name=unisoul" | xargs -r docker rm -f || true
          docker image prune -af || true
          echo "Cleanup completed"

      # ------------------------
      # Create .env
      # ------------------------
      - name: Create .env file
        run: |
          cat > .env << 'EOF'
          APP_NAME=UniSoul
          APP_ENV=production
          APP_KEY=${{ secrets.APP_KEY }}
          APP_DEBUG=false
          APP_URL=${{ vars.APP_URL }}
          APP_PORT=${{ vars.APP_PORT }}

          APP_LOCALE=en
          APP_FALLBACK_LOCALE=en

          LOG_CHANNEL=stack
          LOG_STACK=daily
          LOG_LEVEL=warning

          DB_CONNECTION=pgsql
          DB_HOST=172.17.0.1
          DB_PORT=5432
          DB_DATABASE=${{ vars.DB_DATABASE }}
          DB_USERNAME=${{ vars.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}

          SESSION_DRIVER=database
          SESSION_LIFETIME=120

          CACHE_STORE=redis
          QUEUE_CONNECTION=redis

          REDIS_CLIENT=phpredis
          REDIS_HOST=172.17.0.1
          REDIS_PORT=6379
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}

          MAIL_MAILER=${{ vars.MAIL_MAILER }}
          MAIL_HOST=${{ vars.MAIL_HOST }}
          MAIL_PORT=${{ vars.MAIL_PORT }}
          MAIL_USERNAME=${{ vars.MAIL_USERNAME }}
          MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}
          MAIL_FROM_ADDRESS=${{ vars.MAIL_FROM_ADDRESS }}
          MAIL_FROM_NAME="${APP_NAME}"

          SUPPORTED_LANGUAGES=uk,en,ro,de,ka

          TELEGRAM_TOKEN=${{ secrets.TELEGRAM_TOKEN }}
          OWNER_ID=${{ secrets.OWNER_ID }}

          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL=${{ vars.GEMINI_MODEL }}

          TELEGRAPH_BOT_NAME=${{ vars.TELEGRAPH_BOT_NAME }}
          TELEGRAPH_TOKEN=${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAPH_WEBHOOK_DEBUG=false
          EOF

      # ------------------------
      # Start container
      # ------------------------
      - name: Deploy with Docker Compose
        run: |
          docker compose -f compose.override.raspberry.yml up -d --no-deps
          echo "Container started"

      # ------------------------
      # Wait for app to be ready (fixes 409 errors)
      # ------------------------
      - name: Wait for container readiness
        run: |
          echo "Waiting for app container to be ready..."
          for i in {1..30}; do
            if docker compose -f compose.override.raspberry.yml exec -T app php -v >/dev/null 2>&1; then
              echo "App is ready"
              exit 0
            fi
            echo "Waiting ($i/30)..."
            sleep 2
          done
          echo "App failed to start"
          exit 1

      # ------------------------
      # Migrate DB
      # ------------------------
      - name: Run database migrations
        run: |
          docker compose -f compose.override.raspberry.yml exec -T app php artisan config:clear
          docker compose -f compose.override.raspberry.yml exec -T app php artisan cache:clear
          docker compose -f compose.override.raspberry.yml exec -T app php artisan migrate --force
          echo "Migrations completed"

      # ------------------------
      # Optimize app
      # ------------------------
      - name: Optimize application
        run: |
          docker compose -f compose.override.raspberry.yml exec -T app php artisan config:cache
          docker compose -f compose.override.raspberry.yml exec -T app php artisan route:cache
          docker compose -f compose.override.raspberry.yml exec -T app php artisan view:cache
          echo "Optimization done"

      # ------------------------
      # Health checks
      # ------------------------
      - name: Health check
        run: |
          docker compose -f compose.override.raspberry.yml ps
          docker compose -f compose.override.raspberry.yml exec -T app php artisan --version
          echo "Deployment SUCCESSFUL!"

      # ------------------------
      # Cleanup old images
      # ------------------------
      - name: Cleanup old images
        run: |
          docker image prune -af --filter "until=168h" || true
          echo "Old images cleaned"
