name: Deploy to Raspberry Pi

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy'
        required: true
        default: 'latest'

jobs:
  deploy:
    name: Deploy UniSoul to Raspberry Pi
    runs-on: [self-hosted, Linux, ARM]
    environment: raspberry

    steps:
      - name: Extract image tag
        id: image_tag
        run: |
          TAG="${{ github.event.inputs.image_tag }}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Deploying image tag: ${TAG}"

      - name: Clean workspace
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace alpine:latest \
            sh -c "cd /workspace && ls -A | grep -v '.git' | xargs rm -rf"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Free up memory before pull
        run: |
          echo "Freeing up memory..."
          docker system prune -af --volumes || true
          sync
          echo 3 | sudo tee /proc/sys/vm/drop_caches || true
          echo "Memory status:"
          free -h
          df -h

      - name: Pull latest image with platform specification
        run: |
          # Try pulling with retries and memory optimization
          for i in {1..3}; do
            echo "Pull attempt $i of 3..."
            if docker pull --platform linux/arm64 ${{ secrets.DOCKER_USERNAME }}/unisoul:${{ steps.image_tag.outputs.tag }}; then
              echo "Image pulled successfully!"
              exit 0
            else
              echo "Pull failed, cleaning up and retrying..."
              docker system prune -af || true
              sync
              echo 3 | sudo tee /proc/sys/vm/drop_caches || true
              sleep 5
            fi
          done
          echo "Failed to pull image after 3 attempts"
          exit 1

      - name: Stop and remove old container
        run: |
          docker compose -f compose.override.raspberry.yml down || true
          docker image prune -af --filter "label=app=unisoul"

      - name: Set environment variables for compose
        run: |
          echo "DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}" >> $GITHUB_ENV
          echo "IMAGE_TAG=${{ steps.image_tag.outputs.tag }}" >> $GITHUB_ENV
          echo "APP_PORT=${{ vars.APP_PORT }}" >> $GITHUB_ENV

      - name: Create .env file
        run: |
          cat > .env << 'EOF'
          APP_NAME=UniSoul
          APP_ENV=production
          APP_KEY=${{ secrets.APP_KEY }}
          APP_DEBUG=false
          APP_URL=${{ vars.APP_URL }}
          APP_PORT=${{ vars.APP_PORT }}

          APP_LOCALE=en
          APP_FALLBACK_LOCALE=en

          LOG_CHANNEL=stack
          LOG_STACK=daily
          LOG_LEVEL=warning

          DB_CONNECTION=pgsql
          DB_HOST=host.docker.internal
          DB_PORT=5432
          DB_DATABASE=${{ vars.DB_DATABASE }}
          DB_USERNAME=${{ vars.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}

          SESSION_DRIVER=database
          SESSION_LIFETIME=120

          CACHE_STORE=redis
          QUEUE_CONNECTION=redis

          REDIS_CLIENT=phpredis
          REDIS_HOST=host.docker.internal
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          REDIS_PORT=6379

          MAIL_MAILER=${{ vars.MAIL_MAILER }}
          MAIL_HOST=${{ vars.MAIL_HOST }}
          MAIL_PORT=${{ vars.MAIL_PORT }}
          MAIL_USERNAME=${{ vars.MAIL_USERNAME }}
          MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}
          MAIL_FROM_ADDRESS=${{ vars.MAIL_FROM_ADDRESS }}
          MAIL_FROM_NAME="${APP_NAME}"

          MODEL_SETTINGS_PERSISTENT=true

          SUPPORTED_LANGUAGES=uk,en,ro,de,ka

          TELEGRAM_TOKEN=${{ secrets.TELEGRAM_TOKEN }}
          OWNER_ID=${{ secrets.OWNER_ID }}

          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL=${{ vars.GEMINI_MODEL }}

          TELEGRAPH_BOT_NAME=${{ vars.TELEGRAPH_BOT_NAME }}
          TELEGRAPH_TOKEN=${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAPH_WEBHOOK_DEBUG=false
          EOF

      - name: Deploy with Docker Compose
        run: |
          docker compose -f compose.override.raspberry.yml up -d --no-deps
          echo "Container started successfully"

      - name: Run database migrations
        run: |
          docker compose -f compose.override.raspberry.yml exec -T app php artisan config:clear
          docker compose -f compose.override.raspberry.yml exec -T app php artisan cache:clear
          docker compose -f compose.override.raspberry.yml exec -T app php artisan migrate --force
          echo "Migrations completed"

      - name: Optimize application
        run: |
          docker compose -f compose.override.raspberry.yml exec -T app php artisan config:cache
          docker compose -f compose.override.raspberry.yml exec -T app php artisan route:cache
          docker compose -f compose.override.raspberry.yml exec -T app php artisan view:cache
          echo "Application optimized for production"

      - name: Verify Redis connectivity
        run: |
          echo "Testing Redis connection..."
          docker compose -f compose.override.raspberry.yml exec -T app php artisan tinker --execute="
            try {
              \Illuminate\Support\Facades\Redis::ping();
              echo 'Redis PING: OK\n';
              \Illuminate\Support\Facades\Redis::set('test_key', 'test_value');
              \$value = \Illuminate\Support\Facades\Redis::get('test_key');
              echo 'Redis READ/WRITE: ' . (\$value === 'test_value' ? 'OK' : 'FAILED') . '\n';
              \Illuminate\Support\Facades\Redis::del('test_key');
            } catch (\Exception \$e) {
              echo 'Redis connection failed: ' . \$e->getMessage() . '\n';
              echo 'Please check if Redis is running on the host machine\n';
              exit(1);
            }
          "

      - name: Health check
        run: |
          echo "Running health checks..."
          docker compose -f compose.override.raspberry.yml ps
          docker compose -f compose.override.raspberry.yml exec -T app php artisan --version
          docker compose -f compose.override.raspberry.yml exec -T app php artisan db:show
          echo "Deployment completed successfully!"

      - name: Cleanup old images
        run: |
          docker image prune -af --filter "until=168h"
          echo "Old images cleaned up"
